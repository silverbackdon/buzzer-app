<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bento Box Buzzer</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <!-- Sticky header will be injected here -->
  <div id="headerContainer"></div>

  <div class="bg-orbit"></div>
  <div class="bg-orbit orbit-2"></div>

  <div class="wrap">
    <!-- HOME VIEW -->
    <div id="homeView">
      <div class="card card-glow">
        <h2>Create a room</h2>
        <input id="hostName" class="input" placeholder="Your name (host)" />
        <div class="spacer-xs"></div>
        <button id="createRoomBtn" class="btn btn-secondary">Create room</button>
        <p class="small">
          After creating, you‚Äôll get a <b>room code</b> to share with players.
        </p>
      </div>

      <div class="card">
        <h2>Join with code</h2>
        <input id="joinCodeInput" class="input" placeholder="Enter room code (e.g. GXE123)" />
        <div class="spacer-xs"></div>
        <button id="joinByCodeBtn" class="btn btn-secondary">Join room</button>
        <p class="small">
          Ask the host for the 6-character code.
        </p>
      </div>
    </div>

    <!-- ROOM VIEW -->
    <div id="roomView" style="display:none;">
      <div class="card card-glow">
        <h2>Room</h2>
        <div id="shareBlock"></div>
      </div>

      <div id="joinCard" class="card" style="display:none;">
        <h2>Join room</h2>
        <input id="joinName" class="input" placeholder="Enter your name" />
        <div class="spacer-xs"></div>
        <button id="joinBtn" class="btn btn-primary">Join</button>
      </div>

      <div class="card">
        <h2>Players</h2>
        <div id="membersList"></div>
        <div id="membersHint" class="small hint"></div>
      </div>

      <div class="card buzzer-card">
        <h2>Buzzer</h2>

        <!-- Host controls -->
        <div id="hostControls" class="host-controls" style="display:none;">
          <div class="row">
            <button id="startCountdownBtn" class="btn btn-chip">Start 3-2-1</button>
            <button id="resetBtn" class="btn btn-chip">Reset Buzzer</button>
          </div>
          <div class="small host-note">
            Host controls only
          </div>
        </div>

        <button id="buzzBtn" class="btn buzzer-btn" disabled>BUZZ!</button>
        <p id="statusText" class="small status-text"></p>
        <div id="winnerBox" class="winner-box"></div>
      </div>
    </div>
  </div>

  <!-- Supabase JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /***** SUPABASE KEYS *****/
    const SUPABASE_URL = "https://zeelaeoxbvdryfkorjng.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InplZWxhZW94YnZkcnlma29yam5nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MzI5NjMsImV4cCI6MjA3OTQwODk2M30.2XCH0zX-AmLiHraD3yAi8ub1FIpwkD91h9b983nEqqQ";

    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /***** helpers *****/
    const $ = (id) => document.getElementById(id);

    const params = new URLSearchParams(location.search);
    const roomId = params.get("room");

    const homeView = $("homeView");
    const roomView = $("roomView");
    const joinCard = $("joinCard");
    const buzzBtn = $("buzzBtn");
    const statusText = $("statusText");
    const winnerBox = $("winnerBox");
    const membersList = $("membersList");
    const membersHint = $("membersHint");
    const shareBlock = $("shareBlock");
    const hostControls = $("hostControls");
    const startCountdownBtn = $("startCountdownBtn");
    const resetBtn = $("resetBtn");
    const joinCodeInput = $("joinCodeInput");

    const localKey = (rid) => `buzzer_name_${rid}`;

    let me = null;
    let room = null;
    let channel = null;

    let countdownTimer = null;
    const COUNTDOWN_DEFAULT = 3;

    function generateRoomCode() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function isHostUser() {
      return me && room && me === room.host_name;
    }

    function renderRoom() {
      if (!room) return;

      const host = room.host_name;
      const hostView = isHostUser();
      const code = room.code || "------";

      shareBlock.innerHTML = `
        <div class="small">Room code (share this with players):</div>
        <div class="codeBox">${code}</div>
        <div class="small share-link">
          Room link (optional):<br/>
          <a href="${location.origin}${location.pathname}?room=${room.id}">
            ${location.origin}${location.pathname}?room=${room.id}
          </a>
        </div>
      `;

      membersHint.textContent = hostView
        ? "You are the host. You can remove players with √ó."
        : \`Host is \${host}.\`;

      membersList.innerHTML = "";
      (room.members || []).forEach(n => {
        const row = document.createElement("div");
        row.className = "memberRow";

        const nameEl = document.createElement("div");
        nameEl.className = "memberName";

        const labelHost = (n === host) ? " (host)" : "";
        const labelYou  = (me === n && n !== host) ? " (you)" : "";
        nameEl.textContent = n + labelHost + labelYou;

        row.appendChild(nameEl);

        if (hostView && n !== host) {
          const delBtn = document.createElement("button");
          delBtn.className = "btn deleteBtn";
          delBtn.textContent = "√ó";
          delBtn.setAttribute("data-name", n);
          row.appendChild(delBtn);
        }

        membersList.appendChild(row);
      });

      hostControls.style.display = hostView ? "block" : "none";

      const buzzerCard = document.querySelector(".buzzer-card");

      const now = Date.now();
      const hasCountdown = room.countdown_start && room.countdown_seconds;
      let remainingMs = 0;
      let isOpen = !hasCountdown;

      if (hasCountdown) {
        const startMs = new Date(room.countdown_start).getTime();
        const openMs = startMs + room.countdown_seconds * 1000;
        remainingMs = openMs - now;
        isOpen = remainingMs <= 0;
      }

      if (room.winner_name) {
        buzzBtn.disabled = true;
        buzzBtn.classList.remove("buzzer-active");
        if (buzzerCard) buzzerCard.classList.remove("active");
        startCountdownBtn.disabled = true;
        statusText.textContent = "Buzzer closed.";
        winnerBox.innerHTML = `
          <div class="winner">üèÜ ${room.winner_name} buzzed first!</div>
          <div class="small">${new Date(room.winner_at).toLocaleString()}</div>
        `;
      } else {
        winnerBox.innerHTML = `<div class="small">No winner yet. First buzz wins.</div>`;

        startCountdownBtn.disabled = hasCountdown && !isOpen;

        if (!me) {
          buzzBtn.disabled = true;
          buzzBtn.classList.remove("buzzer-active");
          if (buzzerCard) buzzerCard.classList.remove("active");
          statusText.textContent = "Join to enable buzzer.";
        } else if (!isOpen) {
          buzzBtn.disabled = true;
          buzzBtn.classList.remove("buzzer-active");
          if (buzzerCard) buzzerCard.classList.remove("active");
          const secondsLeft = Math.ceil(remainingMs / 1000);
          statusText.innerHTML = `<span class="countdownText">Countdown‚Ä¶ ${secondsLeft}</span>`;
        } else {
          buzzBtn.disabled = false;
          buzzBtn.classList.add("buzzer-active");
          if (buzzerCard) buzzerCard.classList.add("active");
          statusText.textContent = "Ready‚Ä¶";
        }
      }

      startLocalCountdownTicker();
    }

    function startLocalCountdownTicker() {
      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = null;

      if (!room || !room.countdown_start || !room.countdown_seconds || room.winner_name) return;

      countdownTimer = setInterval(() => {
        renderRoom();
      }, 200);
    }

    async function loadRoom(rid) {
      const { data, error } = await sb
        .from("rooms")
        .select("*")
        .eq("id", rid)
        .single();

      if (error) {
        alert("Room not found.");
        location.href = location.pathname;
        return;
      }
      room = data;
      renderRoom();
    }

    function subscribeRoom(rid) {
      if (channel) sb.removeChannel(channel);

      channel = sb.channel("room-" + rid)
        .on(
          "postgres_changes",
          { event: "UPDATE", schema: "public", table: "rooms", filter: \`id=eq.\${rid}\` },
          payload => {
            room = payload.new;
            renderRoom();
          }
        )
        .subscribe();
    }

    async function createRoom() {
      const hostName = $("hostName").value.trim();
      if (!hostName) return alert("Enter your name.");

      const code = generateRoomCode();

      const { data, error } = await sb
        .from("rooms")
        .insert({
          host_name: hostName,
          members: [hostName],
          winner_name: null,
          winner_at: null,
          countdown_start: null,
          countdown_seconds: null,
          code
        })
        .select()
        .single();

      if (error) {
        alert(error.message || "Error creating room. Try again.");
        return;
      }

      localStorage.setItem(localKey(data.id), hostName);
      location.href = \`\${location.pathname}?room=\${data.id}\`;
    }

    async function joinRoom() {
      const name = $("joinName").value.trim();
      if (!name) return alert("Enter your name.");

      await loadRoom(room.id);

      const already = (room.members || []).includes(name);
      const newMembers = already ? room.members : [...room.members, name];

      const { error } = await sb
        .from("rooms")
        .update({ members: newMembers })
        .eq("id", room.id);

      if (error) return alert(error.message);

      localStorage.setItem(localKey(room.id), name);
      me = name;
      joinCard.style.display = "none";
      renderRoom();
    }

    async function joinByCode() {
      const rawCode = joinCodeInput.value.trim();
      if (!rawCode) return alert("Enter a room code.");
      const code = rawCode.toUpperCase();

      const { data, error } = await sb
        .from("rooms")
        .select("id")
        .eq("code", code)
        .single();

      if (error || !data) {
        alert("Room with that code not found.");
        return;
      }

      location.href = \`\${location.pathname}?room=\${data.id}\`;
    }

    async function deleteMember(nameToDelete) {
      if (!room || !isHostUser()) return;

      await loadRoom(room.id);

      const currentMembers = room.members || [];
      const hostName = room.host_name;

      if (nameToDelete === hostName) return;

      const newMembers = currentMembers.filter(n => n !== nameToDelete);
      const deletingWinner = room.winner_name === nameToDelete;

      const updatePayload = { members: newMembers };

      if (deletingWinner) {
        updatePayload.winner_name = null;
        updatePayload.winner_at = null;
        updatePayload.countdown_start = null;
        updatePayload.countdown_seconds = null;
      }

      const { error } = await sb
        .from("rooms")
        .update(updatePayload)
        .eq("id", room.id);

      if (error) return alert(error.message);

      await loadRoom(room.id);
    }

    async function buzz() {
      if (!me || !room || room.winner_name) return;

      if (room.countdown_start && room.countdown_seconds) {
        const startMs = new Date(room.countdown_start).getTime();
        const openMs = startMs + room.countdown_seconds * 1000;
        if (Date.now() < openMs) return;
      }

      buzzBtn.disabled = true;
      buzzBtn.classList.remove("buzzer-active");
      statusText.textContent = "Buzzing‚Ä¶";

      const { data, error } = await sb
        .from("rooms")
        .update({ winner_name: me, winner_at: new Date().toISOString() })
        .eq("id", room.id)
        .is("winner_name", null)
        .select()
        .single();

      if (error) {
        statusText.textContent = "Someone else won first.";
        await loadRoom(room.id);
        return;
      }

      room = data;
      renderRoom();
    }

    async function startCountdown() {
      if (!room || !isHostUser()) return;

      if (room.countdown_start && room.countdown_seconds && !room.winner_name) {
        const startMs = new Date(room.countdown_start).getTime();
        const openMs = startMs + room.countdown_seconds * 1000;
        if (Date.now() < openMs) return;
      }

      const { error } = await sb
        .from("rooms")
        .update({
          countdown_start: new Date().toISOString(),
          countdown_seconds: COUNTDOWN_DEFAULT,
          winner_name: null,
          winner_at: null
        })
        .eq("id", room.id);

      if (error) alert(error.message);
    }

    async function resetBuzzer() {
      if (!room || !isHostUser()) return;

      const { error } = await sb
        .from("rooms")
        .update({
          winner_name: null,
          winner_at: null,
          countdown_start: null,
          countdown_seconds: null
        })
        .eq("id", room.id);

      if (error) alert(error.message);
    }

    function attachHeaderInteractions() {
      const logoBtn = document.querySelector(".bbb-logo-click");
      if (!logoBtn) return;

      logoBtn.addEventListener("click", () => {
        // Clear query params and go back to home
        location.href = location.pathname;
      });
    }

    async function loadHeader() {
      const container = document.getElementById("headerContainer");
      if (!container) return;

      try {
        const res = await fetch("header.html");
        const html = await res.text();
        container.innerHTML = html;
        attachHeaderInteractions();
      } catch (e) {
        console.error("Failed to load header:", e);
      }
    }

    /***** init *****/
    document.addEventListener("DOMContentLoaded", async () => {
      await loadHeader();

      $("createRoomBtn").onclick = createRoom;
      $("joinBtn").onclick = joinRoom;
      $("joinByCodeBtn").onclick = joinByCode;
      buzzBtn.onclick = buzz;
      startCountdownBtn.onclick = startCountdown;
      resetBtn.onclick = resetBuzzer;

      membersList.addEventListener("click", (e) => {
        if (!isHostUser()) return;
        const btn = e.target.closest(".deleteBtn");
        if (!btn) return;
        const name = btn.getAttribute("data-name");
        if (!name) return;
        deleteMember(name);
      });

      if (!roomId) {
        homeView.style.display = "block";
        roomView.style.display = "none";
        return;
      }

      homeView.style.display = "none";
      roomView.style.display = "block";

      await loadRoom(roomId);
      subscribeRoom(roomId);

      me = localStorage.getItem(localKey(roomId));
      if (!me) {
        joinCard.style.display = "block";
      } else {
        joinCard.style.display = "none";
      }
      renderRoom();
    });
  </script>
</body>
</html>
