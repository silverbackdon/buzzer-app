<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buzzer App</title>
  <style>
    :root { color-scheme: dark; }
    body {
      font-family: system-ui, -apple-system, Arial, sans-serif;
      margin: 0;
      background:#0b0b0c;
      color:#fff;
    }
    .wrap { max-width: 720px; margin: 0 auto; padding: 16px; }
    .card {
      background:#151518;
      border-radius:16px;
      padding:16px;
      margin:12px 0;
      box-shadow:0 6px 18px rgba(0,0,0,.35);
    }
    h1,h2 { margin: 6px 0 10px; }
    input, button {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border-radius: 12px;
      border: none;
      box-sizing: border-box;
    }
    input {
      background:#222227;
      color:#fff;
      outline: 1px solid #333;
    }
    button {
      background:#2b7cff;
      color:white;
      font-weight:700;
      cursor:pointer;
    }
    button.secondary { background:#2a2a2f; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .row { display:flex; gap:8px; }
    .row > * { flex:1; }
    .winner {
      font-size: 20px;
      font-weight: 800;
      color:#7CFF9A;
    }
    .small { opacity:.8; font-size: 13px; }
    a { color:#7db2ff; word-break:break-all; }

    /* Member list rows */
    .memberRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:#232329;
      border-radius:12px;
      padding:8px 10px;
      margin:6px 0;
    }
    .memberName{ font-size:15px; font-weight:600; }
    .deleteBtn{
      width:auto;
      padding:4px 10px;
      font-size:18px;
      line-height:18px;
      border-radius:10px;
      background:#3a3a42;
      font-weight:800;
    }
    .deleteBtn:hover{ background:#ff5b5b; color:#fff; }

    .countdownText {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: .5px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>üì£ Buzzer</h1>

    <!-- HOME VIEW -->
    <div id="homeView" class="card">
      <h2>Create a room</h2>
      <input id="hostName" placeholder="Your name (host)" />
      <div style="height:10px"></div>
      <button id="createRoomBtn">Create room</button>
      <p class="small">
        You‚Äôll get a shareable link like:<br/>
        yoursite.com/?room=xxxx
      </p>
    </div>

    <!-- ROOM VIEW -->
    <div id="roomView" style="display:none;">
      <div class="card">
        <h2>Room</h2>
        <div id="shareBlock"></div>
      </div>

      <div id="joinCard" class="card" style="display:none;">
        <h2>Join room</h2>
        <input id="joinName" placeholder="Enter your name" />
        <div style="height:10px"></div>
        <button id="joinBtn">Join</button>
      </div>

      <div class="card">
        <h2>Members</h2>
        <div id="membersList"></div>
        <div id="membersHint" class="small" style="margin-top:6px; opacity:.7;"></div>
      </div>

      <div class="card">
        <h2>Buzzer</h2>

        <!-- Host controls -->
        <div id="hostControls" style="display:none; margin-bottom:8px;">
          <div class="row">
            <button id="startCountdownBtn" class="secondary">Start 3-2-1 Countdown</button>
            <button id="resetBtn" class="secondary">Reset Buzzer</button>
          </div>
          <div class="small" style="margin-top:6px; opacity:.7;">
            Host controls only
          </div>
        </div>

        <button id="buzzBtn" disabled>BUZZ!</button>
        <p id="statusText" class="small"></p>
        <div id="winnerBox" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <!-- Supabase JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /***** SUPABASE KEYS *****/
    const SUPABASE_URL = "https://zeelaeoxbvdryfkorjng.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InplZWxhZW94YnZkcnlma29yam5nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MzI5NjMsImV4cCI6MjA3OTQwODk2M30.2XCH0zX-AmLiHraD3yAi8ub1FIpwkD91h9b983nEqqQ";

    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /***** helpers *****/
    const $ = (id) => document.getElementById(id);
    const params = new URLSearchParams(location.search);
    const roomId = params.get("room");

    const homeView = $("homeView");
    const roomView = $("roomView");
    const joinCard = $("joinCard");
    const buzzBtn = $("buzzBtn");
    const statusText = $("statusText");
    const winnerBox = $("winnerBox");
    const membersList = $("membersList");
    const membersHint = $("membersHint");
    const shareBlock = $("shareBlock");
    const hostControls = $("hostControls");
    const startCountdownBtn = $("startCountdownBtn");
    const resetBtn = $("resetBtn");

    const localKey = (rid) => `buzzer_name_${rid}`;

    let me = null;
    let room = null;
    let channel = null;

    let countdownTimer = null;
    const COUNTDOWN_DEFAULT = 3;

    function isHostUser() {
      return me && room && me === room.host_name;
    }

    function renderRoom() {
      if (!room) return;

      // Share link
      shareBlock.innerHTML = `
        <div><b>Share this link:</b></div>
        <a href="${location.origin}${location.pathname}?room=${room.id}">
          ${location.origin}${location.pathname}?room=${room.id}
        </a>
      `;

      const host = room.host_name;
      const hostView = isHostUser();

      // Hint text
      membersHint.textContent = hostView
        ? "You are the host. You can remove players with √ó."
        : `Host is ${host}.`;

      // Members list (host-only delete)
      membersList.innerHTML = "";
      (room.members || []).forEach(n => {
        const row = document.createElement("div");
        row.className = "memberRow";

        const nameEl = document.createElement("div");
        nameEl.className = "memberName";

        const labelHost = (n === host) ? " (host)" : "";
        const labelYou  = (me === n && n !== host) ? " (you)" : "";
        nameEl.textContent = n + labelHost + labelYou;

        row.appendChild(nameEl);

        // Show delete only if viewer is host AND target is not host
        if (hostView && n !== host) {
          const delBtn = document.createElement("button");
          delBtn.className = "deleteBtn";
          delBtn.textContent = "√ó";
          delBtn.setAttribute("data-name", n);
          row.appendChild(delBtn);
        }

        membersList.appendChild(row);
      });

      // Host-only controls visibility
      hostControls.style.display = hostView ? "block" : "none";

      // Countdown logic
      const now = Date.now();
      const hasCountdown = room.countdown_start && room.countdown_seconds;
      let remainingMs = 0;
      let isOpen = !hasCountdown;

      if (hasCountdown) {
        const startMs = new Date(room.countdown_start).getTime();
        const openMs = startMs + room.countdown_seconds * 1000;
        remainingMs = openMs - now;
        isOpen = remainingMs <= 0;
      }

      if (room.winner_name) {
        buzzBtn.disabled = true;
        startCountdownBtn.disabled = true;
        statusText.textContent = "Buzzer closed.";
        winnerBox.innerHTML = `
          <div class="winner">üèÜ ${room.winner_name} buzzed first!</div>
          <div class="small">${new Date(room.winner_at).toLocaleString()}</div>
        `;
      } else {
        winnerBox.innerHTML = `<div class="small">No winner yet. First buzz wins.</div>`;

        startCountdownBtn.disabled = hasCountdown && !isOpen;

        if (!me) {
          buzzBtn.disabled = true;
          statusText.textContent = "Join to enable buzzer.";
        } else if (!isOpen) {
          buzzBtn.disabled = true;
          const secondsLeft = Math.ceil(remainingMs / 1000);
          statusText.innerHTML = `<span class="countdownText">Countdown‚Ä¶ ${secondsLeft}</span>`;
        } else {
          buzzBtn.disabled = false;
          statusText.textContent = "Ready‚Ä¶";
        }
      }

      startLocalCountdownTicker();
    }

    function startLocalCountdownTicker() {
      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = null;

      if (!room || !room.countdown_start || !room.countdown_seconds || room.winner_name) return;

      countdownTimer = setInterval(() => {
        renderRoom();
      }, 200);
    }

    async function loadRoom(rid) {
      const { data, error } = await sb
        .from("rooms")
        .select("*")
        .eq("id", rid)
        .single();

      if (error) {
        alert("Room not found.");
        location.href = location.pathname;
        return;
      }
      room = data;
      renderRoom();
    }

    function subscribeRoom(rid) {
      if (channel) sb.removeChannel(channel);

      channel = sb.channel("room-" + rid)
        .on(
          "postgres_changes",
          { event: "UPDATE", schema: "public", table: "rooms", filter: `id=eq.${rid}` },
          payload => {
            room = payload.new;
            renderRoom();
          }
        )
        .subscribe();
    }

    async function createRoom() {
      const hostName = $("hostName").value.trim();
      if (!hostName) return alert("Enter your name.");

      const { data, error } = await sb
        .from("rooms")
        .insert({
          host_name: hostName,
          members: [hostName],
          winner_name: null,
          winner_at: null,
          countdown_start: null,
          countdown_seconds: null
        })
        .select()
        .single();

      if (error) return alert(error.message);

      localStorage.setItem(localKey(data.id), hostName);
      location.href = `${location.pathname}?room=${data.id}`;
    }

    async function joinRoom() {
      const name = $("joinName").value.trim();
      if (!name) return alert("Enter your name.");

      await loadRoom(room.id);

      const already = (room.members || []).includes(name);
      const newMembers = already ? room.members : [...room.members, name];

      const { error } = await sb
        .from("rooms")
        .update({ members: newMembers })
        .eq("id", room.id);

      if (error) return alert(error.message);

      localStorage.setItem(localKey(room.id), name);
      me = name;
      joinCard.style.display = "none";
      renderRoom();
    }

    async function deleteMember(nameToDelete) {
      if (!room || !isHostUser()) return;

      // reload latest
      await loadRoom(room.id);

      const currentMembers = room.members || [];
      const hostName = room.host_name;

      // never delete host
      if (nameToDelete === hostName) return;

      const newMembers = currentMembers.filter(n => n !== nameToDelete);
      const deletingWinner = room.winner_name === nameToDelete;

      const updatePayload = { members: newMembers };

      if (deletingWinner) {
        updatePayload.winner_name = null;
        updatePayload.winner_at = null;
        updatePayload.countdown_start = null;
        updatePayload.countdown_seconds = null;
      }

      const { error } = await sb
        .from("rooms")
        .update(updatePayload)
        .eq("id", room.id);

      if (error) return alert(error.message);

      await loadRoom(room.id);
    }

    async function buzz() {
      if (!me || !room || room.winner_name) return;

      if (room.countdown_start && room.countdown_seconds) {
        const startMs = new Date(room.countdown_start).getTime();
        const openMs = startMs + room.countdown_seconds * 1000;
        if (Date.now() < openMs) return;
      }

      buzzBtn.disabled = true;
      statusText.textContent = "Buzzing‚Ä¶";

      const { data, error } = await sb
        .from("rooms")
        .update({ winner_name: me, winner_at: new Date().toISOString() })
        .eq("id", room.id)
        .is("winner_name", null)
        .select()
        .single();

      if (error) {
        statusText.textContent = "Someone else won first.";
        await loadRoom(room.id);
        return;
      }

      room = data;
      renderRoom();
    }

    async function startCountdown() {
      if (!room || !isHostUser()) return;

      if (room.countdown_start && room.countdown_seconds && !room.winner_name) {
        const startMs = new Date(room.countdown_start).getTime();
        const openMs = startMs + room.countdown_seconds * 1000;
        if (Date.now() < openMs) return;
      }

      const { error } = await sb
        .from("rooms")
        .update({
          countdown_start: new Date().toISOString(),
          countdown_seconds: COUNTDOWN_DEFAULT,
          winner_name: null,
          winner_at: null
        })
        .eq("id", room.id);

      if (error) alert(error.message);
    }

    async function resetBuzzer() {
      if (!room || !isHostUser()) return;

      const { error } = await sb
        .from("rooms")
        .update({
          winner_name: null,
          winner_at: null,
          countdown_start: null,
          countdown_seconds: null
        })
        .eq("id", room.id);

      if (error) alert(error.message);
    }

    /***** init *****/
    $("createRoomBtn").onclick = createRoom;
    $("joinBtn").onclick = joinRoom;
    buzzBtn.onclick = buzz;
    startCountdownBtn.onclick = startCountdown;
    resetBtn.onclick = resetBuzzer;

    // Host-only delete (event delegation)
    membersList.addEventListener("click", (e) => {
      if (!isHostUser()) return;
      const btn = e.target.closest(".deleteBtn");
      if (!btn) return;
      const name = btn.getAttribute("data-name");
      if (!name) return;
      deleteMember(name);
    });

    (async function init() {
      if (!roomId) {
        homeView.style.display = "block";
        roomView.style.display = "none";
        return;
      }

      homeView.style.display = "none";
      roomView.style.display = "block";

      await loadRoom(roomId);
      subscribeRoom(roomId);

      me = localStorage.getItem(localKey(roomId));
      if (!me) {
        joinCard.style.display = "block";
      } else {
        joinCard.style.display = "none";
      }
      renderRoom();
    })();
  </script>
</body>
</html>
